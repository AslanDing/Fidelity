import os
os.environ['CUDA_VISIBLE_DEVICES'] = '1'
import torch
print(torch.cuda.is_available())
from ExplanationEvaluation.configs.selector import Selector
from ExplanationEvaluation.tasks.replication import replication,replication_sp

import nni
from nni.utils import merge_parameter

_dataset = 'mutag'      # One of: bashapes, bacommunity, treecycles, treegrids, ba2motifs, mutag
_explainer = 'pgexplainer' # One of: pgexplainer, gnnexplainer

# Parameters below should only be changed if you want to run any of the experiments in the supplementary
_folder = 'replication' # One of: replication, extension

# PGExplainer
config_path = f"./ExplanationEvaluation/configs/{_folder}/explainers/{_explainer}/{_dataset}.json"
print(config_path)
config = Selector(config_path)

nni_params = nni.get_next_parameter()
config.args.explainer = merge_parameter(config.args.explainer, nni_params)


extension = (_folder == 'extension')

# config.args.explainer.seeds = [0]

(auc, auc_std), inf_time = replication_sp(config.args.explainer, extension,run_qual=False,results_store=False)

print((auc, auc_std), inf_time)

nni.report_final_result(auc)

"""
gnnexplainer
bashapes
fid plus  tensor(0.5778, device='cuda:0') tensor(8.4019e-05, device='cuda:0')
fid minus  tensor(0.3464, device='cuda:0') tensor(0.0016, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.884425620665105, 0.0020439553909541138) 59.51292117436727

fid plus  [0.59627417 0.59627417 0.59627417 0.59619586 0.59614056 0.59614056
 0.59628171 0.5962408  0.59666738 0.59678191 0.50960264] [2.96978198e-04 2.96976603e-04 2.96978097e-04 2.41367961e-04
 2.40305146e-04 2.40305534e-04 5.67579593e-04 5.32853311e-04
 9.68641213e-04 1.74792424e-03 7.27978449e-09]
fid minus  [0.12984306 0.14629425 0.16293556 0.19070556 0.23354062 0.29259143
 0.40290262 0.44168593 0.4669044  0.48277862 0.59777049] [1.97672872e-02 1.73751457e-02 2.15977495e-02 2.88164098e-02
 2.58084634e-02 3.03202267e-02 1.87434201e-02 2.16800887e-02
 9.71276866e-03 9.38592435e-03 7.14569851e-09]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.5        0.54917458 0.59925298 0.64909949 0.69915201 0.74962115
 0.79925617 0.84926007 0.8991552  0.94918499 0.988657  ] [0.00000000e+00 0.00000000e+00 1.11022302e-16 0.00000000e+00
 1.11022302e-16 4.61250544e-06 1.11022302e-16 0.00000000e+00
 0.00000000e+00 1.11022302e-16 0.00000000e+00]
(0.8844257613338845, 0.0020439295551667688) 63.740967869758606



bacommunity
fid plus  tensor(0.2243, device='cuda:0') tensor(0.0009, device='cuda:0')
fid minus  tensor(0.0302, device='cuda:0') tensor(0.0003, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.7059120165481629, 0.003171494309933623) 85.36733984947205

fid plus  [0.45764283 0.45521277 0.45601928 0.45502917 0.45791801 0.45956713
 0.45806897 0.4570217  0.45613114 0.44860378 0.25493578] [8.31995727e-03 5.06037242e-03 5.89002003e-03 4.94210591e-03
 6.35294763e-03 6.58761607e-03 4.84111160e-03 6.03558175e-03
 5.99332046e-03 8.89475433e-03 1.64417547e-08]
fid minus  [0.20118618 0.21460659 0.22875285 0.23437528 0.2410462  0.23777505
 0.24561059 0.25178426 0.26070928 0.26968357 0.46573313] [1.97562431e-02 2.56182530e-02 2.34256731e-02 2.23117126e-02
 2.20005195e-02 2.41847357e-02 2.51445190e-02 3.36528776e-02
 3.21274921e-02 2.99834397e-02 1.36316614e-08]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.50000101 0.54941199 0.59949294 0.64939109 0.69946488 0.74965132
 0.79942863 0.84934699 0.89942314 0.94932609 0.98235972] [3.03745270e-06 8.19653273e-06 1.11022302e-16 3.62843275e-06
 1.11022302e-16 1.11022302e-16 4.78923321e-06 8.92847776e-06
 2.05934048e-06 4.34786081e-06 1.11022302e-16]
(0.7059120038736646, 0.0031714911747402525) 92.08242702484131


treecycles
fid plus  tensor(-0.0435, device='cuda:0') tensor(8.1627e-05, device='cuda:0')
fid minus  tensor(-0.0674, device='cuda:0') tensor(6.2207e-05, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.6830735894970859, 0.008939554416156039) 50.47275900840759

fid plus  [-0.02751511  0.01145159  0.06363317  0.127355    0.18738717  0.21874702
  0.20509759  0.16932616  0.12644123  0.08196149 -0.00957516] [2.04212375e-02 1.91871432e-02 2.06067213e-02 2.03689444e-02
 1.83812711e-02 1.75242804e-02 1.62464501e-02 2.59942834e-02
 1.37628134e-02 1.42964881e-02 6.34079234e-09]
fid minus  [-0.00644878 -0.02022852 -0.03186104 -0.03903093 -0.04384709 -0.03429249
 -0.02508922 -0.02154037 -0.0208153  -0.02522175 -0.09014928] [1.54949995e-02 1.42436027e-02 1.51198250e-02 1.01326361e-02
 4.71137136e-03 4.68879694e-03 5.10781319e-03 6.24587664e-03
 6.48496225e-03 1.01107666e-02 6.20563744e-09]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.50004386 0.53925649 0.58731229 0.63486211 0.68525577 0.74183339
 0.78595401 0.8357921  0.88389749 0.93139773 0.76200367] [1.31579041e-04 0.00000000e+00 0.00000000e+00 1.11022302e-16
 1.11022302e-16 1.11022302e-16 1.11022302e-16 2.22044605e-16
 1.11022302e-16 1.11022302e-16 1.11022302e-16]
(0.6830735143904344, 0.008939501555406251) 62.56458079814911


treegrids
fid plus  tensor(-0.2314, device='cuda:0') tensor(0.0001, device='cuda:0')
fid minus  tensor(-0.2316, device='cuda:0') tensor(0.0001, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.6794759238661785, 0.007748779542030364) 1.3732599882106054

fid plus  [0.46531318 0.46391951 0.45306761 0.44257564 0.42795199 0.41783116
 0.40509145 0.36438099 0.30793622 0.23544187 0.5723722 ] [1.13286317e-02 9.96850057e-03 1.49803705e-02 1.84690417e-02
 1.63475528e-02 1.63396045e-02 1.81671918e-02 2.33537961e-02
 1.79221559e-02 7.70714185e-03 9.76779796e-09]
fid minus  [0.43801628 0.42948258 0.41693337 0.4068694  0.38692657 0.35518925
 0.3331613  0.29365534 0.25893848 0.21601502 0.57236753] [7.97635426e-03 7.80377588e-03 7.67436239e-03 6.86550465e-03
 8.40799361e-03 9.92303292e-03 9.52531440e-03 8.41748051e-03
 7.19130590e-03 7.12864544e-03 9.84910018e-09]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.5        0.54005494 0.58941104 0.63167984 0.68452914 0.74208711
 0.78411427 0.83627152 0.87923238 0.92789641 0.57261553] [0.00000000e+00 1.11022302e-16 1.11022302e-16 0.00000000e+00
 0.00000000e+00 1.11022302e-16 0.00000000e+00 2.22044605e-16
 1.11022302e-16 0.00000000e+00 1.11022302e-16]
(0.510899620214633, 0.005672493273464637) 32.351496236134565


ba2motifs
fid plus  tensor(0.1897, device='cuda:0') tensor(0.0004, device='cuda:0')
fid minus  tensor(0.0528, device='cuda:0') tensor(0.0027, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.6279891445591141, 0.007031441560526663) 317.3491705775261
fid plus  [0.19619533 0.19646045 0.19649441 0.19640893 0.19538567 0.19284467
 0.19389023 0.18321628 0.1701662  0.14030754 0.1992873 ] [1.95719563e-03 2.13312955e-03 1.59978590e-03 1.46981224e-03
 1.79265894e-03 1.88059508e-03 2.81546325e-03 3.74588897e-03
 6.20796414e-03 7.78120425e-03 2.74505113e-09]
fid minus  [0.19526557 0.19581262 0.19596041 0.19606427 0.1955731  0.19707693
 0.19622946 0.19758127 0.1961532  0.19687951 0.18208918] [1.73764958e-03 1.07753020e-03 1.31907076e-03 1.20484272e-03
 1.12973979e-03 6.34397852e-04 6.93709675e-04 3.90753392e-04
 2.46606705e-04 2.39529221e-04 2.16164444e-09]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.5        0.53928589 0.59800643 0.63750065 0.69622116 0.74485
 0.79443592 0.84285643 0.89265062 0.94107116 0.78470129] [0.00000000e+00 1.11022302e-16 0.00000000e+00 1.11022302e-16
 1.11022302e-16 0.00000000e+00 1.11022302e-16 0.00000000e+00
 1.11022302e-16 0.00000000e+00 1.11022302e-16]
(0.6280023384193812, 0.007042320932894473) 323.6283400654793

mutag
(0.5390178435784196, 0.0017399309847693951) 17.631925239938816
fid plus  [0.20986704 0.232591   0.2549844  0.27444237 0.29011414 0.30420982
 0.30505279 0.28762883 0.24631117 0.16650397 0.36448708] [6.34613309e-03 7.44349223e-03 7.08173872e-03 7.37535551e-03
 6.36070102e-03 7.79404843e-03 8.76538608e-03 7.12872060e-03
 6.36140037e-03 4.30372666e-03 1.48386832e-09]
fid minus  [ 0.13726878  0.13728779  0.134369    0.1255786   0.10975084  0.08825768
  0.06783183  0.04047155  0.00789739 -0.02627256  0.14258379] [4.90347877e-03 5.62625886e-03 4.39639602e-03 3.41706417e-03
 2.28015880e-03 3.62395205e-03 4.20792416e-03 4.74998788e-03
 4.17178583e-03 3.64316783e-03 8.38954140e-10]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.50000182 0.54048978 0.5920506  0.64120624 0.6916024  0.74517035
 0.79152136 0.84060699 0.89111149 0.94132345 0.88775234] [5.47345049e-06 1.11022302e-16 0.00000000e+00 0.00000000e+00
 1.11022302e-16 1.11022302e-16 1.11022302e-16 0.00000000e+00
 0.00000000e+00 2.22044605e-16 0.00000000e+00]
(0.5390172541350254, 0.001740249108556751) 25.32906484838777

"""


"""
ba2motifs
fid_plus_mean [0.15716999 0.15474655 0.15330252 0.15193353 0.14949418 0.14602179
 0.14678691 0.13640613 0.1374819  0.13922764 0.19928295]
fid_minus_mean [0.1980794  0.19941753 0.19909402 0.20154506 0.20232057 0.20338395
 0.19998126 0.19865735 0.19537813 0.19432078 0.18208918]
fid_plus_label_mean [0.48  0.48  0.48  0.48  0.48  0.48  0.48  0.455 0.435 0.43  0.48 ]
fid_minus_label_mean [0.48 0.48 0.48 0.48 0.48 0.48 0.48 0.48 0.48 0.48 0.48]
sparsity_mean [0.51813583 0.55303765 0.60997487 0.64674969 0.70418706 0.75209296
 0.80050507 0.84842785 0.89670734 0.94480368 0.7843162 ]
delta_fid_mean [-0.04090941 -0.04467099 -0.0457915  -0.04961153 -0.05282639 -0.05736216
 -0.05319434 -0.06225122 -0.05789623 -0.05509314  0.01719377]
delta_fid_label_mean [ 0.     0.     0.     0.     0.     0.     0.    -0.025 -0.045 -0.05
  0.   ]
score: 0.5058806146572105

mutag
fid_plus_mean [0.09498232 0.09498232 0.09498232 0.09498232 0.09498232 0.09498645
 0.09523862 0.09772812 0.10083184 0.08802569 0.36448707]
fid_minus_mean [0.33263486 0.33263486 0.33263486 0.33263486 0.33263486 0.33261363
 0.33273343 0.33084844 0.33146238 0.32907706 0.47859253]
fid_plus_label_mean [0.07192118 0.07192118 0.07192118 0.07192118 0.07192118 0.07192118
 0.07192118 0.0729064  0.07192118 0.03546798 0.45221675]
fid_minus_label_mean [0.4226601  0.4226601  0.4226601  0.4226601  0.4226601  0.4226601
 0.4226601  0.41477833 0.4137931  0.31921182 0.63349754]
sparsity_mean [0.92681948 0.92681948 0.92681948 0.92681948 0.92681948 0.92682539
 0.92693114 0.9279646  0.93204731 0.95393903 0.98744323]
delta_fid_mean [-0.23765255 -0.23765255 -0.23765255 -0.23765255 -0.23765254 -0.23762718
 -0.23749481 -0.23312032 -0.23063054 -0.24105138 -0.11410545]
delta_fid_label_mean [-0.35073892 -0.35073892 -0.35073892 -0.35073892 -0.35073892 -0.35073892
 -0.35073892 -0.34187192 -0.34187192 -0.28374384 -0.18128079]
score: 0.2679700720385177
time_elased: 145.2277070783042
Run 1 with seed 1


"""
