import os
os.environ['CUDA_VISIBLE_DEVICES'] = '4'
import torch
print(torch.cuda.is_available())
from ExplanationEvaluation.configs.selector import Selector
from ExplanationEvaluation.tasks.replication import replication,replication_sp

import nni
from nni.utils import merge_parameter

_dataset = 'mutag'      # One of: bashapes, bacommunity, treecycles, treegrids, ba2motifs, mutag
_explainer = 'pgexplainer' # One of: pgexplainer, gnnexplainer

# Parameters below should only be changed if you want to run any of the experiments in the supplementary
_folder = 'replication' # One of: replication, extension

# PGExplainer
config_path = f"./ExplanationEvaluation/configs/{_folder}/explainers/{_explainer}/{_dataset}.json"
print(config_path)
config = Selector(config_path)

nni_params = nni.get_next_parameter()
config.args.explainer = merge_parameter(config.args.explainer, nni_params)


extension = (_folder == 'extension')

# config.args.explainer.seeds = [0]

(auc, auc_std), inf_time = replication_sp(config.args.explainer, extension,run_qual=False,results_store=False)

print((auc, auc_std), inf_time)

nni.report_final_result(auc)


"""
pgexplainer
bashapes
(0.9994826891277387, 6.988603334294414e-05) 7.7132526238759365

fid plus  tensor(0.5562, device='cuda:0') tensor(0.0030, device='cuda:0')
fid minus  tensor(0.4969, device='cuda:0') tensor(0.0116, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.9994826891277386, 6.988603334297191e-05) 8.782876968383789

fid plus  [0.59777049 0.59777048 0.59777049 0.59777048 0.59777049 0.59777048
 0.59777049 0.59777048 0.59777049 0.60495584 0.50960265] [6.23736176e-09 8.47901680e-09 6.95050391e-09 9.33555075e-09
 5.48381629e-09 9.50889217e-09 6.91634366e-09 1.00168370e-08
 6.69815990e-09 8.96774406e-04 8.37685181e-09]
fid minus  [0.05258266 0.0513992  0.05356111 0.05520542 0.05487373 0.05283327
 0.0516097  0.05665417 0.06040075 0.07616623 0.59777049] [1.30575382e-02 1.05420544e-02 1.12817036e-02 1.39898966e-02
 1.41252075e-02 1.22337820e-02 1.46969258e-02 7.96564783e-03
 6.00705654e-03 6.55480919e-03 7.69496662e-09]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.5        0.5491759  0.59925826 0.64910128 0.69915201 0.74962465
 0.79925617 0.84926585 0.8991552  0.94918499 0.988657  ] [0.00000000e+00 3.97443771e-06 1.58226490e-05 5.39958477e-06
 1.11022302e-16 1.50850415e-05 1.11022302e-16 1.34071561e-05
 0.00000000e+00 1.11022302e-16 0.00000000e+00]
(0.9994826891277387, 6.988603334294219e-05) 15.165517687797546



bacommunity
(0.8252311802078752, 0.04012944434703194) 10.976306398709616

fid plus  tensor(0.1067, device='cuda:0') tensor(0.0016, device='cuda:0')
fid minus  tensor(0.1010, device='cuda:0') tensor(0.0015, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.8252311939385818, 0.04012944877253489) 11.409528175989786

fid plus  [0.48365738 0.48637169 0.48729543 0.48608466 0.49006175 0.49266606
 0.49286551 0.49844962 0.49472077 0.48162964 0.25493578] [4.03531007e-03 5.01592112e-03 5.78026233e-03 1.50777136e-02
 1.69765629e-02 2.03804088e-02 1.68574650e-02 1.40803787e-02
 1.68976445e-02 3.08235408e-02 1.84437564e-08]
fid minus  [0.10066311 0.11058016 0.11959046 0.1337583  0.1516369  0.16800811
 0.19383898 0.22537792 0.24536841 0.27964756 0.46573313] [2.20294538e-02 2.78517880e-02 3.29847341e-02 2.95223431e-02
 2.98261952e-02 2.21517793e-02 2.96643264e-02 2.75036089e-02
 3.46694739e-02 3.55094461e-02 1.49835688e-08]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.5        0.54941059 0.59949351 0.64938988 0.69946488 0.74965132
 0.79942704 0.84934561 0.89942245 0.94932464 0.98235972] [0.00000000e+00 3.99380922e-06 1.70052052e-06 0.00000000e+00
 1.11022302e-16 1.11022302e-16 1.11022302e-16 4.78923321e-06
 1.11022302e-16 1.11022302e-16 1.11022302e-16]
(0.8252311770392508, 0.04012944897866299) 18.632524172465004



 treecycles
(0.7627814997296161, 0.014428929828404005) 0.5170480012893677

fid plus  tensor(-0.0582, device='cuda:0') tensor(0.0001, device='cuda:0')
fid minus  tensor(-0.0582, device='cuda:0') tensor(0.0001, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.7627815748362675, 0.014429258128577116) 1.107977310816447

fid plus  [ 0.10428213  0.10488707  0.11226265  0.11997022  0.11081697  0.09480391
  0.12183627  0.11044613  0.07926961  0.06114235 -0.00957516] [2.38040094e-02 2.39072798e-02 2.04860150e-02 2.46031847e-02
 2.81583058e-02 3.19784054e-02 1.54486363e-02 2.62544678e-02
 3.47612190e-02 2.98387116e-02 1.14041014e-08]
fid minus  [-0.01466556  0.00185146 -0.00282362 -0.0219167  -0.02142384 -0.04287969
 -0.08748539 -0.06844384 -0.07087733 -0.08307503 -0.09014929] [3.31101990e-02 2.54106527e-02 2.59927283e-02 1.61405443e-02
 1.75641032e-02 1.13266180e-02 1.04691698e-02 4.51429930e-03
 3.39498444e-03 2.89032400e-03 1.00250847e-08]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.50858555 0.55531643 0.59364837 0.65248149 0.69264729 0.75391102
 0.79455908 0.84843862 0.89729238 0.94010607 0.76200367] [9.25187557e-04 1.60756752e-03 1.05456340e-03 1.88419158e-03
 1.31618890e-03 9.56109737e-04 9.82960589e-04 1.54043272e-03
 1.08004568e-03 7.95555608e-04 1.11022302e-16]
(0.7627817250495703, 0.014429299912442456) 7.451708237330118



treegrids
fid plus  tensor(-0.2314, device='cuda:0') tensor(0.0001, device='cuda:0')
fid minus  tensor(-0.2316, device='cuda:0') tensor(0.0001, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.6794759238661785, 0.007748779542030364) 1.3732599882106054

fid plus  [0.43769328 0.46116436 0.51111941 0.51144205 0.53718873 0.49225004
 0.47009446 0.39178338 0.36576014 0.34865667 0.57237219] [1.58196528e-02 2.13823711e-02 1.06462188e-02 1.03138506e-02
 2.72980752e-02 1.61853972e-02 3.59668313e-02 6.18692452e-02
 8.80615858e-02 1.06400279e-01 9.15607535e-09]
fid minus  [0.17250918 0.13110808 0.1517902  0.10538282 0.23628623 0.20529284
 0.18837633 0.21865696 0.18638806 0.17103213 0.57236752] [4.49405012e-02 5.54575445e-02 5.93199031e-02 4.00787927e-02
 6.93474096e-02 2.01064761e-02 1.27991953e-02 9.55688805e-03
 1.17156433e-02 1.32852980e-02 8.96987121e-09]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.50469765 0.54677476 0.59538186 0.63618672 0.68590665 0.74504174
 0.79006426 0.83939924 0.88729616 0.929367   0.57261553] [5.15084343e-04 7.72227532e-04 9.14087226e-04 1.24729244e-03
 2.94199223e-04 6.56432336e-04 5.98205695e-04 5.39250711e-04
 5.18214320e-04 3.73077228e-04 1.11022302e-16]
(0.6794759182870069, 0.007748782506060804) 7.1178214607766765

ba2motifs
fid plus  tensor(0.1934, device='cuda:0') tensor(7.5478e-06, device='cuda:0')
fid minus  tensor(0.0137, device='cuda:0') tensor(0.0001, device='cuda:0')
fid label plus  0.0 0.0
fid label minus  0.0 0.0
(0.6907224137184231, 0.055903348746313586) 1.3190996527671814
fid plus  [0.20040508 0.20139835 0.19933248 0.19933743 0.20122878 0.19776954
 0.20046326 0.18846045 0.24581789 0.23328982 0.19928295] [3.94334309e-03 4.07818301e-03 3.48343665e-03 3.35756422e-03
 3.14489127e-03 2.69981303e-03 2.60188558e-03 4.47907297e-03
 2.50144170e-02 2.24940568e-02 1.98470937e-09]
fid minus  [0.20217884 0.20203753 0.20348009 0.20223501 0.20187866 0.20245931
 0.19837697 0.19799859 0.19454066 0.19694011 0.18208918] [1.19237399e-03 1.42286334e-03 9.87557340e-04 1.44763192e-03
 1.06685411e-03 1.56656965e-03 4.79715414e-04 7.20638031e-04
 1.01744932e-03 1.00145833e-03 1.66493389e-09]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.51394509 0.551835   0.60573543 0.64347864 0.70142139 0.7494822
 0.79640566 0.84482513 0.89551902 0.94725295 0.7843162 ] [0.00136732 0.00127082 0.00125125 0.00048262 0.00078082 0.00065089
 0.00064235 0.00045642 0.00053309 0.00216652 0.        ]
(0.6906416034615217, 0.055992219582928854) 8.25946888923645

mutag
(0.8434804910106148, 0.08421108305765386) 5.285042309408705

fid plus  [-0.02806597 -0.02806597 -0.02806518 -0.02805962 -0.02795794 -0.02763947
 -0.02659151 -0.02289884 -0.00417707  0.0355776   0.36448707] [4.73253087e-02 4.73253088e-02 4.73247047e-02 4.73203873e-02
 4.72415682e-02 4.70051674e-02 4.62580054e-02 4.42516370e-02
 3.61309827e-02 4.46888368e-02 8.34983298e-10]
fid minus  [0.41381962 0.41381962 0.41380188 0.41371727 0.41301257 0.41283737
 0.41384763 0.41953385 0.4492972  0.47111804 0.47859253] [9.82796161e-02 9.82796161e-02 9.82915083e-02 9.83572946e-02
 9.88227484e-02 9.89988919e-02 9.78119937e-02 9.24703141e-02
 7.28022344e-02 5.52869196e-02 1.02006279e-09]
fid label plus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
fid label minus  [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
sparse  [0.90281865 0.90281865 0.90281978 0.90284677 0.90306522 0.90371447
 0.90486946 0.90799767 0.9211354  0.95284559 0.98744323] [0.02966842 0.02966842 0.02966733 0.02964256 0.02945564 0.02893638
 0.0281851  0.02612468 0.01769902 0.00498505 0.        ]
(0.8434805913626858, 0.08421085195926002) 13.503122855877056

"""

"""
embedding 
f  oringial + GT
f*  oringial + GT
f'  oringial + GT
"""
